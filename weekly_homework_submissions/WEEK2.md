# Easy Wins

## New Roles
* [tasks/roles/compliance](https://github.com/johnsondnz/NetAutSol/tree/master/tasks/roles/compliance)
* [tasks/roles/compliance_reports](https://github.com/johnsondnz/NetAutSol/tree/master/tasks/roles/compliance_reports)

## New Plays
* [tasks/compliance_play.yml](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/compliance_play.yml)
  * Inherits `compliance` and `compliance_report` roles.

## Compliance Role
* [verify.sh](https://github.com/johnsondnz/NetAutSol/blob/master/verify.sh) will call [tasks/compliance_play.yml](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/compliance_play.yml).
* `tasks/compliance_play.yml` triggers the roles `compliance` and `compliance_reports`.
* The play uses `include_vars` to import variables from the `config_fabric` role.  
  * [tasks/roles/config_fabric/vars/main.yml](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/roles/config_fabric/vars/main.yml)
* A custom module I wrote called [tasks/roles/compliance/library/compliance_test.py](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/roles/compliance/library/compliance_test.py).
  * Used to standardise compliance testing it allows for key-value search with recursive search of structured data or;
  * python re.search of unstructured data.
  * results are standardised and prefix with `compliance_test_` before being returned as ansible_facts.
    * the module returns ansible_facts for use later in report generation.
  * usage examples and returned facts are provided in the module.
* Compliance tests:
  * `tasks/roles/config_fabric/vars/main.yml` is used to generate an ansible_facts dictionary called `fabric_tests`.
    * `fabric_tests` is a list of dictionarys.
    * `{'ping_test': ip_address, 'interface': interface}`
  * `show isis adjacency` is executed on the Junos Olives
  * `fabric_tests.interface` is used as a re.search to look for the interface in an 'Up' state, i.e. 'em1.*?Up'
  * `fabric_tests.ping_dest` is passed to `naplam_ping` with results stored in `ping_results`
  * `ping_results` is passed to `compliance_test` module and results ouput standardised into ansible_facts.

## Tasks
- [tasks/roles/compliance/tasks/main.yml](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/roles/compliance/tasks/main.yml)
  - Dynamically includes `getter` and `test` modules.
  - [tasks/roles/compliance/tasks/getters/](https://github.com/johnsondnz/NetAutSol/tree/master/tasks/roles/compliance/tasks/getters)
    - Information gathering tasks.
  - [tasks/roles/compliance/tasks/tests/](https://github.com/johnsondnz/NetAutSol/tree/master/tasks/roles/compliance/tasks/tests)
    - Compliance tasks which make use of the custom module [tasks/roles/compliance/library/compliance_test.py](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/roles/compliance/library/compliance_test.py).
- [tasks/roles/compliance_reports/tasks/main.yml](https://github.com/johnsondnz/NetAutSol/blob/master/tasks/roles/compliance_reports/tasks/main.yml)
  - Dynamically calls the ordered tasks in [tasks/roles/compliance_reports/tasks/includes/](https://github.com/johnsondnz/NetAutSol/tree/master/tasks/roles/compliance_reports/tasks/includes)
  - Each tasks file is prefixed with a index to esnure order of operation is as expected for report generation

## Compliance Reporting Role
* Triggered with running [verify.sh](https://github.com/johnsondnz/NetAutSol/blob/master/verify.sh).
* Play creates [reports](https://github.com/johnsondnz/NetAutSol/tree/master/reports) directory.
  * subdirectories `build` and `debug` are also created.
* Report header and contents are generated from the role [tasks/roles/compliance_reports/templates](https://github.com/johnsondnz/NetAutSol/tree/master/tasks/roles/compliance_reports/templates) templates.
  * A report header is created for each host and placed into `reports/build/{{ inventory_hostanme }}`
  * Report content is created for each host and placed into `reports/build/{{ inventory_hostanme }}`
  * Report content is generated by looping through the ansible_facts prefixed with `compliance_test_` and passing it to `tasks/roles/compliance_reports/templates/output.j2`
* Assemble module is used to combine the header and report contents
* Each hosts assembled a report is placed into `reports`
* Summary report information is placed at the end of each host report, including passed and failed test counts.
* An aggregated report is generated combining all hosts into a MEGA report, it too is placed into `reports`
* Debugging information is saved to [reports/debug](https://github.com/johnsondnz/NetAutSol/tree/master/reports/debug) in JSON and YAML format.
* The last output is a search of generated reports (excluding the aggregated one) using bash and grep.  Script searches for `'[FAIL]'`, matches are printed to stdout

## Examples
- [examples/00-full-report.txt](https://github.com/johnsondnz/NetAutSol/blob/master/examples/00-full-report.txt)
- [examples/DEPLOY-OUTPUT.md](https://github.com/johnsondnz/NetAutSol/blob/master/examples/DEPLOY-OUTPUT.md)
- [examples/GENERATE-OUTPUT.md](https://github.com/johnsondnz/NetAutSol/blob/master/examples/GENERATE-OUTPUT.md)
- [examples/ROLLBACK-OUTPUT.md](https://github.com/johnsondnz/NetAutSol/blob/master/examples/ROLLBACK-OUTPUT.md)
- [examples/VERIFY-OUTPUT.md](https://github.com/johnsondnz/NetAutSol/blob/master/examples/VERIFY-OUTPUT.md)
