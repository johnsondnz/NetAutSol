{% macro configure_interface(name, index, is_left, peer, peer_node, peer_iface) -%}
{% set index = (index - 1) * 2 %}
{% set network = "{}.{}/31".format(fabric_link_ipv4_prefix, index) %}
{% set ip = network|ipaddr('0') if is_left else network|ipaddr('-1') %}
{% set peer_ip = network|ipaddr('-1') if is_left else network|ipaddr('0') %}

interfaces {
	/* link_index: {{ index }} | {{ inventory_hostname }} {{ name }}.0 {{ ip }} --> {{ peer_ip }} {{ peer_iface }}.0 {{ peer_node }} */
	{{ name }} {
		mtu {{ fabric_mtu }};
		description "WAN | {{ peer_node }} {{ peer_iface }}";
		unit 0 {
			family inet {
				address {{ ip }};
			}
			family mpls;
            {% if isis %}
            family iso;
            {% endif %}
		}
	}
}
protocols {
	rsvp {
        interface {{ name }}.0;
	}
	mpls {
		{% if colours is defined -%}
		interface {{ name }}.0 {
        	admin-group [ {{ colours }} ];
        }
        {% else %}
        interface {{ name }}.0;
        {% endif %}
    }
    ldp {
    	interface {{ name }}.0;
        keepalive-timeout {{ ldp_keepalive_timeout }};
    }
    {% if isis %}
    isis {
        interface {{ name }}.0 {
            point-to-point;
            level 1 disable;
            level 2 {
                metric {{ isis_default_cost }};
                hello-interval {{ isis_hello_interval }};
            }
        }
    }
    {% endif %}
    {% if ospf %}
    ospf {
        area {{ ospf_backbone_area }} {
        	interface {{ name }}.0 {
                interface-type p2p;
                dead-interval {{ ospf_dead_interval }};
            }
        }
    }
    {% endif %}
}
{% endmacro %}

{% set loopback_ip = "{}.{}/32".format(loopback_net, id)|ipaddr('address') %}
{% set loopback_prefix = "{}.0/24".format(loopback_net) %}
{% if isis %}
{% set padded_id = "0{}".format(id) if id <= 9 else "{}".format(id) %}
{% set iso_address = "{}.00{}.00".format(iso_afi_area_system, padded_id) %}
{% endif %}
interfaces {
	lo0 {
        unit 0 {
            description "PEERING INTERFACE --- DO NOT DELETE";
            family inet {
                address {{ loopback_ip }};
            }
            {% if isis %}
            family iso {
            	address {{ iso_address }};
            }
            {% endif %}
        }
    }
}
routing-options {
	router-id {{ loopback_ip }};
	autonomous-system {{ ibgp_asn }};
    dynamic-tunnels {
        dt-1 {
            rsvp-te rsvp-te-1 {
                label-switched-path-template {
                    default-template;
                }
                destination-networks {
                    {{ loopback_prefix }};
                }
            }
        }
    }
}

{% for link in fabric %}
{% if inventory_hostname == link.left %}
{{ configure_interface(link.left_port, loop.index, true, link.right, link.right, link.right_port) }}
{% elif inventory_hostname == link.right %}
{{ configure_interface(link.right_port, loop.index, false, link.left, link.left, link.left_port) }}
{% endif %}
{% endfor %}